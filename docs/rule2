ğŸ” ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¼•ãç¶™ãã‚µãƒãƒªãƒ¼ï¼ˆPerp DEX Frontend Ã— Backendï¼‰
1ï¸âƒ£ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

ç›®çš„
Perpetual DEX ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆï¼‰ã‚’æ¥ç¶šã—ã€
UIã‚’å¤‰æ›´ã›ãšã«ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’é †ç•ªã«å®Ÿè£…ã—ã¦ã„ã‚‹ã€‚

â‘  depositï¼ˆè¨¼æ‹ é‡‘å…¥é‡‘ï¼‰ âœ… å®Œäº†
â‘¡ openPositionï¼ˆæ–°è¦å»ºç‰ï¼‰ âœ… å®Œäº†
â‘¢ close / partial closeï¼ˆæ±ºæ¸ˆï¼‰ â† æ¬¡ã“ã“
â‘£ claimPnL
â‘¤ withdraw


é‡è¦æ–¹é‡

âŒ ãƒ•ãƒ­ãƒ³ãƒˆUIã®æ§‹é€ ãƒ»è¡¨ç¤ºã¯å¤‰æ›´ã—ãªã„

âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®ã€Œç¹‹ãè¾¼ã¿ã®ã¿ã€ã‚’è¡Œã†

âœ… ä¸è¶³æƒ…å ±ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä»•æ§˜ã‚’ç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè£…

2ï¸âƒ£ ä½¿ç”¨è¨€èªãƒ»æŠ€è¡“
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

React + TypeScript

ethers v6

Tailwind / shadcn-ui

Vite

MetaMask

Binance WebSocketï¼ˆä¾¡æ ¼è¡¨ç¤ºç”¨ï¼‰

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

Solidity ^0.8.20

Perpetual DEX ç‹¬è‡ªå®Ÿè£…

Chainlinkäº’æ› Oracleï¼ˆUSD Ã— 1e8ï¼‰

MockERC20ï¼ˆCollateralï¼‰

3ï¸âƒ£ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆé‡è¦ï¼‰
/home/deploy/ui_work/perpx-frontend/client
â”œâ”€ src/
â”‚  â”œâ”€ pages/
â”‚  â”‚  â””â”€ Trade.tsx                # ãƒ¡ã‚¤ãƒ³ã®å–å¼•ç”»é¢ï¼ˆUIå®Œæˆæ¸ˆã¿ï¼‰
â”‚  â”‚
â”‚  â”œâ”€ components/
â”‚  â”‚  â””â”€ DepositPanel.tsx          # è¨¼æ‹ é‡‘å…¥é‡‘UIï¼ˆUIè¿½åŠ æ¸ˆã¿ï¼‰
â”‚  â”‚
â”‚  â”œâ”€ lib/
â”‚  â”‚  â””â”€ eth/
â”‚  â”‚     â”œâ”€ addresses.ts           # å…¨ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹å®šç¾©ï¼ˆç¢ºå®šï¼‰
â”‚  â”‚     â”œâ”€ getRouter.ts            # Router contract wrapper
â”‚  â”‚     â”œâ”€ deposit.ts              # approve + Router.deposit
â”‚  â”‚     â”œâ”€ getPositions.ts         # on-chain position å–å¾—ãƒ­ã‚¸ãƒƒã‚¯
â”‚  â”‚     â””â”€ abi/
â”‚  â”‚        â”œâ”€ Router.ts
â”‚  â”‚        â”œâ”€ ERC20.ts
â”‚  â”‚        â””â”€ Oracle.ts

4ï¸âƒ£ ãƒ•ãƒ­ãƒ³ãƒˆå´ã§ã€Œã™ã§ã«å®Œäº†ã—ã¦ã„ã‚‹ã“ã¨ã€
âœ… Deposit

CollateralTokenï¼ˆMockERC20ï¼‰ã« approve

Router.deposit(uint256)

UIï¼šTradeç”»é¢æœ€ä¸Šéƒ¨ã« DepositPanel ã‚’è¿½åŠ ï¼ˆUIæ§‹é€ å¤‰æ›´ãªã—ï¼‰

âœ… openPosition

pairï¼šbytes32ï¼ˆä¾‹ "tUSD" â†’ ethers.encodeBytes32String("tUSD"))

sizeï¼šint256ï¼ˆç¬¦å·ä»˜ãã€USD notionalï¼‰

openPosition ãŒ on-chain ã§æˆåŠŸ

MetaMask ã§ tx ç¢ºèªæ¸ˆã¿

âœ… Position ä¸€è¦§è¡¨ç¤ºï¼ˆUIå¤‰æ›´ãªã—ï¼‰

getUserPositionIds(user)

getPosition(user, positionId)

oracle.getPrice(pair)

ãƒ•ãƒ­ãƒ³ãƒˆã§ä»¥ä¸‹ã‚’è¨ˆç®—ï¼š

side

pnl

pnlPercentage

leverage

æ—¢å­˜ UI ã® Positions ã‚¿ãƒ–ã«è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿

5ï¸âƒ£ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆï¼‰ç¢ºå®šæƒ…å ±
ğŸ”¹ IPerp ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆæ­£æœ¬ï¼‰
interface IPerp {

    /* ===== Margin ===== */
    function onTraderDeposit(address user, uint256 amount) external;
    function onTraderWithdraw(address user, uint256 amount) external;

    /* ===== Position ===== */
    function openPosition(address user, bytes32 pair, int256 size)
        external
        returns (uint256 positionId);

    function closePosition(address user, uint256 positionId) external;
    function closePositionPartial(address user, uint256 positionId, int256 closeSize) external;

    function liquidate(address user, uint256 positionId) external;

    /* ===== PnL ===== */
    function claimPnL(address user) external;
    function getClaimablePnL(address user) external view returns (int256);

    /* ===== Views ===== */
    function getPosition(address user, uint256 positionId)
        external
        view
        returns (
            bytes32 pair,
            int256 size,
            uint256 entryPrice,
            uint256 margin,
            bool isOpen
        );

    function getMargin(address user) external view returns (uint256);
    function getUserPositionIds(address user) external view returns (uint256[]);
}

6ï¸âƒ£ Oracle ã®ä»•æ§˜ï¼ˆç¢ºå®šï¼‰
oracle.getPrice(bytes32 pair)


æˆ»ã‚Šå€¤ï¼šuint256

å˜ä½ï¼šUSD Ã— 1e8

ç¬¦å·ï¼šæ­£ã®ã¿ï¼ˆsize å´ã§ long / short ç®¡ç†ï¼‰

ãƒ•ãƒ­ãƒ³ãƒˆã§ã®æ‰±ã„
priceUsd = Number(price) / 1e8;

7ï¸âƒ£ ãƒ•ãƒ­ãƒ³ãƒˆã§ã® Position ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆUIæœŸå¾…å½¢ï¼‰
position = {
  id,             // uint256 â†’ string
  symbol,         // decodeBytes32String(pair)
  side,           // 'long' | 'short'
  leverage,       // ãƒ•ãƒ­ãƒ³ãƒˆè¨ˆç®—ï¼ˆcross marginï¼‰
  size,           // abs(size)
  entryPrice,     // USD
  currentPrice,   // USDï¼ˆoracleï¼‰
  pnl,            // ãƒ•ãƒ­ãƒ³ãƒˆè¨ˆç®—
  pnlPercentage,  // ãƒ•ãƒ­ãƒ³ãƒˆè¨ˆç®—
}

è¨ˆç®—ãƒ«ãƒ¼ãƒ«ï¼ˆç¢ºå®šï¼‰
side = size > 0 ? "long" : "short";

pnl =
  side === "long"
    ? (currentPrice - entryPrice) * abs(size)
    : (entryPrice - currentPrice) * abs(size);

leverage = (abs(size) * currentPrice) / traderMargin;
pnlPercentage = (pnl / traderMargin) * 100;

8ï¸âƒ£ ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆSepoliaï¼‰
{
  "CollateralToken": "0x11cB4dFC26ba6F0e62410193A9Ccd786Ab1e04cf",
  "PLP": "0x5dcd62b7ea6E485A998D34cA7798FF3D691f2FCa",
  "LiquidityPool": "0x7C61e3020a98f9185eCB21032808E922e8A4A425",
  "PriceOracle": "0x315DA136160FF129A9d2966a2569Fd968755d959",
  "PerpetualTrading": "0x009D3705e5B79EF5147565AA85ED893A293Af9B2",
  "LiquidationEngine": "0xbf2489F041587586fb4F3f3BbB623cC9DC3eacB1",
  "Router": "0xF881590b3C85D50c85B0c7991aD07ef913b28046"
}

ãƒ•ãƒ­ãƒ³ãƒˆå´ addresses.tsï¼ˆç¢ºå®šç‰ˆï¼‰
export const CONTRACTS = {
  COLLATERAL_TOKEN: "0x11cB4dFC26ba6F0e62410193A9Ccd786Ab1e04cf",
  PLP: "0x5dcd62b7ea6E485A998D34cA7798FF3D691f2FCa",
  LIQUIDITY_POOL: "0x7C61e3020a98f9185eCB21032808E922e8A4A425",
  ROUTER: "0xF881590b3C85D50c85B0c7991aD07ef913b28046",
  PERPETUAL_TRADING: "0x009D3705e5B79EF5147565AA85ED893A293Af9B2",
  ORACLE: "0x315DA136160FF129A9d2966a2569Fd968755d959",
  LIQUIDATION_ENGINE: "0xbf2489F041587586fb4F3f3BbB623cC9DC3eacB1",
} as const;

9ï¸âƒ£ æ¬¡ã«ã‚„ã‚‹ã“ã¨ï¼ˆæ¬¡ãƒãƒ£ãƒƒãƒˆã®é–‹å§‹åœ°ç‚¹ï¼‰
ğŸ”œ STEP â‘¢ï¼šclose / partial close

UIï¼šã™ã§ã« Close ãƒœã‚¿ãƒ³ã‚ã‚Šï¼ˆå¤‰æ›´ä¸è¦ï¼‰

å®Ÿè£…å¯¾è±¡ï¼š

handleClosePosition(positionId)

Router / IPerp ã® closePosition or closePositionPartial

UIã¯è§¦ã‚‰ãšã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‘¼ã³å‡ºã—ã®ã¿

ç¢ºèªãŒå¿…è¦ãªç‚¹ï¼ˆæ¬¡ãƒãƒ£ãƒƒãƒˆå†’é ­ã§èãã“ã¨ï¼‰

Router å´ã® close ã®ã‚·ã‚°ãƒãƒãƒ£
ï¼ˆrouter.closePosition(positionId) ã‹
router.closePosition(address user, uint256 positionId) ã‹ï¼‰


 <TabsContent value="positions" className="p-4 space-y-2">
  {positions.length === 0 && (
    <div className="text-sm text-white/60">No open positions</div>
  )}

  {positions.map(p => (
    <Card key={p.id} className="p-3">
      <div className="font-medium">{p.symbol}</div>
      <div className="text-xs text-white/60">
        Opened: {new Date(p.openedAt).toLocaleString()}
      </div>
    </Card>
  ))}
</TabsContent>



 <TabsContent value="positions" className="p-4 space-y-2">
  {positions.length === 0 && (
    <div className="text-sm text-white/60">No open positions</div>
  )}

  {positions.map(p => (
    <Card key={p.id} className="p-3">
      <div className="font-medium">{p.symbol}</div>
      <div className="text-xs text-white/60">
        Opened: {new Date(p.openedAt).toLocaleString()}
      </div>
    </Card>
  ))}
</TabsContent>



<TabsContent value="trade-history" className="p-4 space-y-2">
  {tradeHistory.map(t => (
    <Card key={t.id} className="p-3">
      <div className="flex justify-between">
        <div>{t.symbol} Â· {t.side}</div>
        <div className={t.pnl >= 0 ? "text-green-500" : "text-red-500"}>
          {t.pnl.toFixed(2)}
        </div>
      </div>
      <div className="text-xs text-white/60">
        {new Date(t.timestamp).toLocaleString()}
      </div>
    </Card>
  ))}
</TabsContent>

<TabsContent value="order-book" className="p-3">
                    <div className="space-y-1">
                      <div className="grid grid-cols-3 gap-2 text-xs text-white/60 mb-2">
                        <div>Price (USDT)</div>
                        <div className="text-right">Size (USDT)</div>
                        <div className="text-right">Sum (USDT)</div>
                      </div>
                      
                      {orderBookAsks.map((ask, i) => (
                        <div key={i} className="grid grid-cols-3 gap-2 text-xs">
                          <div className="text-red-500">{ask.price}</div>
                          <div className="text-white/60 text-right">{ask.size}</div>
                          <div className="text-white/60 text-right">{ask.sum}</div>
                        </div>
                      ))}
                      <div className="text-lg font-bold text-white my-2">111,062.6 â†“</div>
                      {orderBookBids.map((bid, i) => (
                        <div key={i} className="grid grid-cols-3 gap-2 text-xs">
                          <div className="text-green-500">{bid.price}</div>
                          <div className="text-white/60 text-right">{bid.size}</div>
                          <div className="text-white/60 text-right">{bid.sum}</div>
                        </div>
                      ))}
                    </div>
                  </TabsContent>

                  <Input
                  placeholder="Search"
                  className="mb-3 bg-background border-white/10 text-sm"
                />
                <div className="space-y-1">
                  {markets.map((market) => (
                    <button
                      key={market.symbol}
                      className="w-full p-2 hover:bg-white/5 rounded transition-colors text-left"
                    >

                     <TabsContent value="open-orders" className="p-4 space-y-2">
  {orders.map(o => (
    <Card key={o.id} className="p-3">
      <div>Close Requested</div>
      <div className="text-xs">
        Position #{o.positionId}
      </div>
    </Card>
  ))}
</TabsContent>

<TabsContent value="order-book" className="p-3">
                    <div className="space-y-1">
                      <div className="grid grid-cols-3 gap-2 text-xs text-white/60 mb-2">
                        <div>Price (USDT)</div>
                        <div className="text-right">Amount (BTC)</div>
                        <div className="text-right">Total (USDT)</div>
                      </div>
                      {orderBookAsks.map((ask, i) => (
                        <div key={i} className="grid grid-cols-3 gap-2 text-xs">
                          <div className="text-red-500">{ask.price}</div>
                          <div className="text-white/60 text-right">{(parseFloat(ask.size.replace(/,/g, '')) / 111073).toFixed(4)}</div>
                          <div className="text-white/60 text-right">{ask.sum}</div>
                        </div>

                        <div className="text-lg font-bold text-white my-2">111,062.6 â†“</div>
                      {orderBookBids.map((bid, i) => (
                        <div key={i} className="grid grid-cols-3 gap-2 text-xs">
                          <div className="text-green-500">{bid.price}</div>